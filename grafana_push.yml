---
- name: Export AWX Inventory Hosts to Grafana
  hosts: localhost
  gather_facts: false
  vars:
    awx_inventory_name: "{{ AWX_INVENTORY_NAME }}"

  tasks:

    # -----------------------------
    # 1️⃣ Map environment variables
    # -----------------------------
    - name: Set database variables from environment
      set_fact:
        postgres_host: "{{ AWX_POSTGRES_HOST }}"
        postgres_port: "{{ AWX_POSTGRES_PORT | int }}"
        postgres_db: "{{ AWX_POSTGRES_DB }}"
        postgres_user: "{{ AWX_POSTGRES_USER }}"
        postgres_password: "{{ AWX_POSTGRES_PASSWORD }}"

    - name: Set Grafana variables from environment
      set_fact:
        grafana_url: "{{ GRAFANA_URL }}"
        grafana_token: "{{ GRAFANA_TOKEN | trim | replace('\n','') | replace('\r','')}}"     
        grafana_dashboard_uid: "adcqlkp"   # change to your dashboard's UID

    # -----------------------------
    # 2️⃣ Validate required environment variables
    # -----------------------------
    - name: Validate required environment variables
      assert:
        that:
          - postgres_host is defined and postgres_host != ''
          - postgres_port is defined
          - postgres_db is defined and postgres_db != ''
          - postgres_user is defined and postgres_user != ''
          - grafana_url is defined and grafana_url != ''
          - grafana_token is defined and grafana_token != ''
        fail_msg: "One or more required environment variables are missing."

    # -----------------------------
    # 3️⃣ Query AWX inventory hosts
    # -----------------------------

    - name: Query AWX inventory hosts
      community.postgresql.postgresql_query:
        login_host: "{{ AWX_POSTGRES_HOST }}"
        login_port: "{{ AWX_POSTGRES_PORT | int }}"
        login_user: "{{ AWX_POSTGRES_USER }}"
        login_password: "{{ AWX_POSTGRES_PASSWORD | trim }}"
        login_db: "{{ AWX_POSTGRES_DB }}"   # <-- use login_db (or 'db' as legacy alias)
        query: |
          SELECT h.id, h.name, h.variables
          FROM main_host h
          JOIN main_inventory i ON h.inventory_id = i.id
          WHERE i.name = %s
          ORDER BY h.name
        positional_args:
          - "{{ AWX_INVENTORY_NAME }}"
        login_unix_socket: ''
      register: pg_query
      delegate_to: localhost


    # Inspect once to confirm shape
    - name: Inspect pg_query
      debug:
        var: pg_query

    # 1) Prefer the EE's primary shape: query_all_results[0]
    - name: Normalize rows list (EE-compatible)
      set_fact:
        _raw_rows: "{{ pg_query.query_all_results | first | default([]) }}"

    # 2) Fallback to other shapes if empty
    - name: Fallback rows shape
      set_fact:
        _raw_rows: "{{ pg_query.rows | default(pg_query.results[0].rows | default([])) }}"
      when: _raw_rows | length == 0

    # Init parsed_hosts
    - name: Init parsed_hosts
      set_fact:
        parsed_hosts: []

    # Build parsed_hosts = [{id, name, vars}, ...] decoding JSON safely
    - name: Build parsed_hosts objects
      set_fact:
        parsed_hosts: >-
          {{
            parsed_hosts + [ {
              'id': (item.id | default(item['id'])),
              'name': (item.name | default(item['name'])),
              'vars': (
                ((item.variables | default('{}')) is string)
              ) | ternary(
                    (item.variables | default('{}') | from_json),
                    (item.variables | default({}))
                  )
            } ]
          }}
      loop: "{{ _raw_rows }}"
      loop_control:
        label: "{{ (item.name | default(item['name'])) | default('row') }}"

    # Quick sanity check
    - name: Hostnames we will push
      debug:
        msg: "{{ parsed_hosts | map(attribute='name') | list }}"

    # -----------------------------
    # 4️⃣ Push inventory to Grafana (example)
    # -----------------------------
    - name: Show host count
      debug:
        msg: "Found {{ parsed_hosts | length }} hosts in inventory '{{ awx_inventory_name }}'"

    - name: Test Grafana connectivity
      uri:
        url: "{{ GRAFANA_URL }}/api/health"
        method: GET
        headers:
          Authorization: "Bearer {{ GRAFANA_TOKEN }}"
        validate_certs: no
      register: grafana_health
    
    - debug:
        var: grafana_health

    - name: Check Grafana user
      uri:
        url: "{{ GRAFANA_URL }}/api/user"
        method: GET
        headers:
          Authorization: "Bearer {{ GRAFANA_TOKEN }}"
        validate_certs: no
      register: grafana_user
    
    - debug:
        var: grafana_user

    - name: Compute epoch_ms (int)
      set_fact:
        epoch_ms: "{{ (lookup('pipe', 'date +%s') | int) * 1000 }}"

    - name: Verify type of epoch_ms
      debug:
        msg: "epoch_ms={{ epoch_ms }} type={{ epoch_ms | type_debug }}"
    # Expect: type=int

    # 2) Build a dashboard-scoped annotation body using the UID (NOT numeric ID)
    - name: Build annotation body (dashboard-scoped)
      set_fact:
        grafana_annotation_body:
          dashboardUID: "{{ grafana_dashboard_uid }}"           # use one source of truth
          time: "{{ epoch_ms | int }}"                          # ensure int inside the dict
          text: "AWX Inventory Sync — {{ awx_inventory_name }}" # keep casing consistent
          tags:
            - awx
            - awx_inventory
            - "{{ awx_inventory_name }}"

    - name: Sanity check body types
      debug:
        msg:
          - "time={{ grafana_annotation_body.time }} type={{ grafana_annotation_body.time | type_debug }}"
          - "body_json={{ grafana_annotation_body | to_nice_json }}"
    # Expect: type=int and the printed JSON shows time without quotes


    # Hard-constrains once more (works reliably)
    - name: Force 'time' to int inside the dict
      set_fact:
        grafana_annotation_body: >-
            {{ grafana_annotation_body | combine({'time': (grafana_annotation_body.time | int)}) }}

    # - name: Create annotation (dashboard-scoped) # only to test the body
    #   uri:
    #     url: "{{ grafana_url }}/api/annotations"
    #     method: POST
    #     headers:
    #       Authorization: "Bearer {{ grafana_token | trim }}"
    #       Content-Type: "application/json"
    #     body_format: json        
    #     body: >-
    #       {{ grafana_annotation_body
    #         | combine({'time': (grafana_annotation_body.time | int)}) }}

    #     validate_certs: no
    #     status_code: [200, 201, 202, 204]
    #     return_content: yes
    #   register: grafana_annotation_push

    # - debug:
    #     msg: "Status={{ grafana_annotation_push.status }} Content={{ grafana_annotation_push.content | default('') }}"



    # --- Push each host to Grafana annotations (hard-coerce time to int) ---

    # Build per-host payload (string-safe). We’ll coerce 'time' to int when sending.
    # - name: Build per-host annotation payloads
    #   set_fact:
    #     grafana_host_payloads: "{{ (grafana_host_payloads | default([])) + [{
    #       'dashboardUID': grafana_dashboard_uid,
    #       'tags': ['awx_inventory', awx_inventory_name, item.name],
    #       'text': (
    #         '**Host:** ' ~ item.name ~ '\n' ~
    #         '**ID:** ' ~ (item.id | string) ~ '\n' ~
    #         '**IP Address:** ' ~ (item.vars.zammad_info.ip_address | default('N/A')) ~ '\n' ~
    #         '**Owner:** ' ~ (item.vars.zammad_info.owner | default('N/A')) ~ '\n' ~
    #         '**State:** ' ~ (item.vars.zammad_info.state | default('N/A')) ~ '\n' ~
    #         '**OS:** ' ~ (item.vars.zammad_info.os | default('N/A')) ~ '\n' ~
    #         '**Kernel:** ' ~ (item.vars.zammad_info.kernel | default('N/A')) ~ '\n' ~
    #         '**CPU Count:** ' ~ (item.vars.zammad_info.cpu_count | default('N/A') | string) ~ '\n' ~
    #         '**RAM:** ' ~ (item.vars.zammad_info.ram_gb | default('N/A')) ~ ' GB\n' ~
    #         '**Zammad Version:** ' ~ (item.vars.zammad_info.zammad_version | default('N/A')) ~ '\n' ~
    #         '**Zammad Status:** ' ~ (item.vars.zammad_info.zammad_active | ternary('Active', 'Inactive')) ~ '\n' ~
    #         '**Redis:** ' ~ (item.vars.redis_info.installed | default('no')) ~ ' (v' ~ (item.vars.redis_info.version | default('-')) ~ ')\n' ~
    #         '**Elasticsearch:** ' ~ (item.vars.elasticsearch_info.installed | default('no')) ~ ' (v' ~ (item.vars.elasticsearch_info.version | default('-')) ~ ')\n' ~
    #         '**KIT Packages:** ' ~ (item.vars.zammad_info.kit_packages | default('None')) ~ '\n' ~
    #         '**Last Updated:** ' ~ (item.vars.zammad_info.last_updated | default('N/A'))
    #       ),
    #       'time': ((lookup('pipe', 'date +%s') | int) * 1000)
    #     }] }}"
    #   loop: "{{ parsed_hosts }}"
    #   loop_control:
    #     label: "{{ item.name }}"

    - name: Build per-host annotation payloads
      set_fact:
        grafana_host_payloads: "{{ (grafana_host_payloads | default([])) + [{
          'dashboardUID': grafana_dashboard_uid,
          'tags': ['awx_inventory', awx_inventory_name, item.name],
          'text': (
            item.vars.zammad_info | default({})
            | combine({
              'host': item.name,
              'id': item.id | string,
              'ip_address': item.vars.zammad_info.ip_address | default('N/A'),
              'owner': item.vars.zammad_info.owner | default('N/A'),
              'state': item.vars.zammad_info.state | default('N/A'),
              'os': item.vars.zammad_info.os | default('N/A'),
              'kernel': item.vars.zammad_info.kernel | default('N/A'),
              'cpu_count': item.vars.zammad_info.cpu_count | default('N/A') | string,
              'ram_gb': item.vars.zammad_info.ram_gb | default('N/A'),
              'zammad_version': item.vars.zammad_info.zammad_version | default('N/A'),
              'zammad_status': item.vars.zammad_info.zammad_active | default(false) | ternary('Active', 'Inactive'),
              'postgresql_installed': item.vars.postgresql_info.installed | default('no'),
              'postgresql_version': item.vars.postgresql_info.version | default('-'),
              'redis_installed': item.vars.redis_info.installed | default('no'),
              'redis_version': item.vars.redis_info.version | default('-'),
              'elasticsearch_installed': item.vars.elasticsearch_info.installed | default('no'),
              'elasticsearch_version': item.vars.elasticsearch_info.version | default('-'),
              'kit_packages': item.vars.zammad_info.kit_packages | default('None'),
              'last_updated': item.vars.zammad_info.last_updated | default('N/A')
            })
            | to_json
          ),
          'time': ((lookup('pipe', 'date +%s') | int) * 1000)
        }] }}"
      loop: "{{ parsed_hosts }}"
      loop_control:
        label: "{{ item.name }}"

    # Optional: sanity check the first payload to confirm types before sending
    - name: Sanity check a sample host payload (debug)
      when: grafana_host_payloads | length > 0
      debug:
        msg:
          - "sample time value={{ grafana_host_payloads[0].time }} type={{ grafana_host_payloads[0].time | type_debug }}"
          - "sample body_json={{ grafana_host_payloads[0] | to_nice_json }}"

    # Push each host, hard-coercing 'time' to integer at send time
    - name: Push each host to Grafana annotations (hard-coerce time)
      uri:
        url: "{{ grafana_url }}/api/annotations"
        method: POST
        headers:
          Authorization: "Bearer {{ grafana_token | trim }}"
          Content-Type: "application/json"
        body_format: json
        body: >-
          {{ item | combine({'time': (item.time | int)}) }}
        validate_certs: no
        status_code: [200, 201, 202, 204]
        return_content: yes
      loop: "{{ grafana_host_payloads }}"
      loop_control:
        label: "{{ item.tags[2] | default('host') }}"
      register: grafana_push_result
      failed_when: false

    # Report any failed pushes (keeps the play running)
    - name: Report failed host pushes
      debug:
        msg: "Failed to push {{ item.item.tags[2] | default('host') }}: {{ item.msg | default(item.content | default('Unknown error')) }}"
      loop: "{{ grafana_push_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.tags[2] | default('host') }}"
      when: item.failed | default(false)

    - name: Final Summary
      debug:
        msg: |
          ========================================
          AWX → Grafana Sync Complete
          Inventory: {{ awx_inventory_name }}
          Total Hosts: {{ parsed_hosts | length }}
          Successfully Pushed: {{ grafana_push_result.results | selectattr('failed','undefined') | list | length }}
          Failed: {{ grafana_push_result.results | selectattr('failed','defined') | selectattr('failed') | list | length }}
          Grafana URL: {{ grafana_url }}
          Timestamp: {{ now(utc=True).isoformat() }}


    
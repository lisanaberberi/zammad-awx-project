---
# ======================================
# Host Reachability Monitoring Playbook
# ======================================
# This playbook checks if all hosts in the zammad_servers group are reachable
# and sends email alerts via KIT SMTP server (smtp.kit.edu).
# 
# Run every 2 hours via CronJob or AWX schedule
# ======================================

- name: Host Reachability Monitoring and Alerting
  hosts: localhost
  gather_facts: yes
  connection: local
  become: no
  
  vars:
    # SMTP Configuration - Use smarthost.kit.edu (no auth needed from KIT network)
    # OR use smtp.kit.edu with authentication
    smtp_host: "{{ smtp_host | default('smarthost.kit.edu') }}"
    smtp_port: "{{ smtp_port | default(25) }}"
    smtp_username: "{{ smtp_username | default('') }}"
    smtp_password: "{{ smtp_password | default('') }}"
    smtp_use_tls: "{{ smtp_use_tls | default(false) }}"
    
    # Email Configuration
    email_from: "{{ smtp_username }}@kit.edu"  # Use authenticated user's email
    alert_recipients: ["ops-team@kit.edu"]
    test_email_recipient: "your-email@kit.edu"  # Change this to your email for testing
    
    # Monitoring Configuration
    check_port: 22
    check_timeout: 5
    alert_on_unreachable: true
    
    # Report settings
    report_dir: "/runner/artifacts"
    
  pre_tasks:
    - name: Display inventory hosts
      debug:
        msg: |
          Monitoring the following hosts from inventory:
          {% for host in groups['zammad_servers'] %}
          - {{ host }}
            IP: {{ hostvars[host].ansible_host | default('N/A') }}
            State: {{ hostvars[host].state | default('N/A') }}
            Owner: {{ hostvars[host].owner | default('N/A') }}
          {% endfor %}

  tasks:
    - name: Create artifacts directory
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

    - name: Initialize reachability report
      set_fact:
        host_reachability:
          timestamp: "{{ now(utc=True).isoformat() }}"
          check_port: "{{ check_port }}"
          reachable_hosts: []
          unreachable_hosts: []
          total_checked: "{{ groups['zammad_servers'] | length }}"
          hosts_detail: {}

    - name: Check connectivity to all hosts
      wait_for:
        host: "{{ hostvars[item].ansible_host | default(item) }}"
        port: "{{ check_port }}"
        timeout: "{{ check_timeout }}"
        state: started
      loop: "{{ groups['zammad_servers'] }}"
      register: reachability_check
      ignore_errors: yes
      changed_when: false

    - name: Parse reachability results with host details
      set_fact:
        host_reachability: >-
          {{
            host_reachability | combine({
              'reachable_hosts': host_reachability.reachable_hosts + ([] if item is failed else [item.item]),
              'unreachable_hosts': host_reachability.unreachable_hosts + ([] if item is succeeded else [item.item]),
              'hosts_detail': host_reachability.hosts_detail | combine({
                item.item: {
                  'ip': hostvars[item.item].ansible_host | default('N/A'),
                  'state': hostvars[item.item].state | default('N/A'),
                  'owner': hostvars[item.item].owner | default('N/A'),
                  'reachable': item is succeeded
                }
              })
            })
          }}
      loop: "{{ reachability_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Display reachability summary
      debug:
        msg: |
          =========================
          Reachability Check Summary
          =========================
          Timestamp: {{ host_reachability.timestamp }}
          Total Hosts: {{ host_reachability.total_checked }}
          Reachable: {{ host_reachability.reachable_hosts | length }}
          Unreachable: {{ host_reachability.unreachable_hosts | length }}
          
          REACHABLE HOSTS:
          {% for host in host_reachability.reachable_hosts | sort %}
          âœ“ {{ host }}
            IP: {{ host_reachability.hosts_detail[host].ip }}
            State: {{ host_reachability.hosts_detail[host].state }}
            Owner: {{ host_reachability.hosts_detail[host].owner }}
          {% endfor %}
          
          {% if host_reachability.unreachable_hosts %}
          UNREACHABLE HOSTS:
          {% for host in host_reachability.unreachable_hosts | sort %}
          âœ— {{ host }}
            IP: {{ host_reachability.hosts_detail[host].ip }}
            State: {{ host_reachability.hosts_detail[host].state }}
            Owner: {{ host_reachability.hosts_detail[host].owner }}
          {% endfor %}
          {% endif %}

    - name: Send alert email - Unreachable hosts detected
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username if smtp_username else omit }}"
        password: "{{ smtp_password if smtp_password else omit }}"
        secure: "{{ 'starttls' if smtp_use_tls else 'never' }}"
        from: "{{ email_from }}"
        to: "{{ alert_recipients }}"
        subject: "ðŸš¨ ALERT: {{ host_reachability.unreachable_hosts | length }} host(s) unreachable - {{ host_reachability.timestamp }}"
        body: |
          HOST REACHABILITY ALERT
          =======================
          
          Timestamp: {{ host_reachability.timestamp }}
          
          STATUS: UNREACHABLE HOSTS DETECTED
          
          {{ host_reachability.unreachable_hosts | length }} out of {{ host_reachability.total_checked }} hosts are currently unreachable.
          
          UNREACHABLE HOSTS:
          {% for host in host_reachability.unreachable_hosts | sort %}
          â€¢ {{ host }} ({{ host_reachability.hosts_detail[host].ip }})
            State: {{ host_reachability.hosts_detail[host].state }}
            Owner: {{ host_reachability.hosts_detail[host].owner }}
          {% endfor %}
          
          REACHABLE HOSTS:
          {% for host in host_reachability.reachable_hosts | sort %}
          â€¢ {{ host }} ({{ host_reachability.hosts_detail[host].ip }})
            State: {{ host_reachability.hosts_detail[host].state }}
            Owner: {{ host_reachability.hosts_detail[host].owner }}
          {% endfor %}
          
          SUMMARY:
          - Total Hosts: {{ host_reachability.total_checked }}
          - Reachable: {{ host_reachability.reachable_hosts | length }}
          - Unreachable: {{ host_reachability.unreachable_hosts | length }}
          - Check Method: SSH Port {{ host_reachability.check_port }}
          
          Please investigate the unreachable hosts immediately.
          
          Regards,
          Automated Monitoring System
      when:
        - alert_on_unreachable | bool
        - host_reachability.unreachable_hosts | length > 0
      ignore_errors: yes

    - name: Send test email - For verification (optional)
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username if smtp_username else omit }}"
        password: "{{ smtp_password if smtp_password else omit }}"
        secure: "{{ 'starttls' if smtp_use_tls else 'never' }}"
        from: "{{ email_from }}"
        to: ["{{ test_email_recipient }}"]
        subject: "Test: Host Monitoring System - {{ host_reachability.timestamp }}"
        body: |
          This is a test email from the Host Monitoring System.
          
          All {{ host_reachability.total_checked }} hosts are currently reachable:
          
          {% for host in host_reachability.reachable_hosts | sort %}
          âœ“ {{ host }} ({{ host_reachability.hosts_detail[host].ip }})
          {% endfor %}
          
          If you received this email, the monitoring system is working correctly.
          
          Regards,
          Automated Monitoring System
      ignore_errors: yes

    - name: Set play result
      set_fact:
        monitoring_result:
          status: "{% if host_reachability.unreachable_hosts | length == 0 %}success{% else %}warning{% endif %}"
          unreachable_count: "{{ host_reachability.unreachable_hosts | length }}"
          reachable_count: "{{ host_reachability.reachable_hosts | length }}"

    - name: Final summary
      debug:
        msg: |
          ===== MONITORING COMPLETE =====
          Status: {{ monitoring_result.status | upper }}
          Reachable: {{ monitoring_result.reachable_count }}
          Unreachable: {{ monitoring_result.unreachable_count }}
          
          Reports saved to: {{ report_dir }}
          Emails sent via KIT SMTP ({{ smtp_host }}:{{ smtp_port }})
          ==============================="
---
# ======================================
# Host Reachability Monitoring Playbook
# ======================================
# This playbook checks if all hosts in the zammad_servers group are reachable
# and sends email alerts via KIT SMTP server (smtp.kit.edu).
# 
# Run every 2 hours via CronJob or AWX schedule
# ======================================

- name: Host Reachability Monitoring and Alerting
  hosts: localhost
  gather_facts: yes
  connection: local
  become: no
  
  vars:
    # SMTP Configuration - Use smarthost.kit.edu (no auth needed from KIT network)
    # OR use smtp.kit.edu with authentication
    smtp_host: "{{ smtp_host | default('smarthost.kit.edu') }}"
    smtp_port: "{{ smtp_port | default(25) }}"
    # smtp_username: "{{ smtp_username | default('') }}"
    # smtp_password: "{{ smtp_password | default('') }}"
    smtp_use_tls: "{{ smtp_use_tls | default(false) }}"
    
    # Email Configuration
    email_from: "{{ smtp_username }}@kit.edu"  # Use authenticated user's email
    alert_recipients: ["{{ smtp_username }}@kit.edu"]  # Change to desired alert recipients
    test_email_recipient: "lisana.berberi@kit.edu"  # Change this to your email for testing
    
    # Monitoring Configuration
    check_port: 22
    check_timeout: 5
    alert_on_unreachable: true

        # Disk monitoring configuration
    disk_usage_threshold: 95  # Alert if usage > 95%
    monitored_filesystems:  # List of filesystems to check
      - "/"
      - "/var"
    
    
    # Certificate monitoring configuration
    cert_expiry_warning_days: 30  # Alert if expires in < 30 days
    cert_paths:  # Paths to check for SSL certificates
      - "/etc/ssl/certs"
      - "/etc/letsencrypt/live"
    
    # Report settings
    report_dir: "/runner/artifacts"
    
  pre_tasks:
    - name: Display inventory hosts
      debug:
        msg: |
          Monitoring the following hosts from inventory:
          {% for host in groups['zammad_servers'] %}
          - {{ host }}
            IP: {{ hostvars[host].ansible_host | default('N/A') }}
            State: {{ hostvars[host].state | default('N/A') }}
            Owner: {{ hostvars[host].owner | default('N/A') }}
          {% endfor %}

  tasks:
    - name: Create artifacts directory
      file:
        path: "{{ report_dir }}"
        state: directory
        mode: '0755'

 
    - name: Initialize comprehensive monitoring report
      set_fact:
        monitoring_report:
          timestamp: "{{ now(utc=True).isoformat() }}"
          reachability:
            check_port: "{{ check_port }}"
            reachable_hosts: []
            unreachable_hosts: []
            total_checked: "{{ groups['zammad_servers'] | length }}"
            hosts_detail: {}
          disk_space:
            checked_hosts: []
            high_usage_hosts: []
            hosts_detail: {}
          certificates:
            checked_hosts: []
            expiring_soon: []
            expired: []
            hosts_detail: {}

    # ================================
    # TASK 1: CHECK HOST REACHABILITY
    # ================================

    - name: Check connectivity to all hosts
      wait_for:
        host: "{{ hostvars[item].ansible_host | default(item) }}"
        port: "{{ check_port }}"
        timeout: "{{ check_timeout }}"
        state: started
      loop: "{{ groups['zammad_servers'] }}"
      register: reachability_check
      ignore_errors: yes
      changed_when: false

    - name: Parse reachability results with host details
      set_fact:
        monitoring_report: >-
          {{
            monitoring_report | combine({
              'reachability': monitoring_report.reachability | combine({
                'reachable_hosts': monitoring_report.reachability.reachable_hosts + ([] if item is failed else [item.item]),
                'unreachable_hosts': monitoring_report.reachability.unreachable_hosts + ([] if item is succeeded else [item.item]),
                'hosts_detail': monitoring_report.reachability.hosts_detail | combine({
                  item.item: {
                    'ip': hostvars[item.item].ansible_host | default('N/A'),
                    'state': hostvars[item.item].state | default('N/A'),
                    'owner': hostvars[item.item].owner | default('N/A'),
                    'reachable': item is succeeded
                  }
                })
              })
            })
          }}
      loop: "{{ reachability_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    # ================================
    # TASK 2: CHECK DISK SPACE
    # ================================
    - name: Check disk space on reachable hosts
      shell: |
        for fs in {{ monitored_filesystems | join(' ') }}; do
          usage=$(df -h "$fs" 2>/dev/null | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "FILESYSTEM:$fs|USAGE:$usage"
        done
      register: disk_usage_check
      loop: "{{ monitoring_report.reachability.reachable_hosts }}"
      loop_control:
        label: "{{ item }}"
      delegate_to: "{{ item }}"
      ignore_errors: yes
      changed_when: false

    - name: Initialize disk details
      set_fact:
        disk_details: {}
        high_usage_filtered: []

    - name: Parse disk usage output and build details
      block:
        - name: Process each host's disk output
          set_fact:
            disk_details: "{{ disk_details | combine({item.item: item.stdout | from_json}) }}"
            high_usage_filtered: "{{ high_usage_filtered + ([item.item] if ('true' in item.stdout) else []) }}"
          loop: "{{ disk_usage_check.results }}"
          loop_control:
            label: "{{ item.item }}"
          vars:
            json_output: |
              {
              {% set ns = namespace(first=true) %}
              {% for line in item.stdout_lines %}
                {% if 'FILESYSTEM:' in line %}
                  {% if not ns.first %},{% endif %}
                  {% set parts = line.split('|') %}
                  {% set fs = parts[0].split(':')[1] %}
                  {% set usage = parts[1].split(':')[1] | int(0) %}
                  "{{ fs }}": {"usage": {{ usage }}, "alert": {{ (usage > disk_usage_threshold) | lower }}}
                  {% set ns.first = false %}
                {% endif %}
              {% endfor %}
              }
          register: disk_parse_result

    - name: Update monitoring report with disk space data
      set_fact:
        monitoring_report: >-
          {{
            monitoring_report | combine({
              'disk_space': {
                'checked_hosts': monitoring_report['reachability']['reachable_hosts'],
                'high_usage_hosts': high_usage_filtered,
                'hosts_detail': disk_details
              }
            }, recursive=True)
          }}
      when: disk_details is defined and disk_details | length > 0
      loop_control:
        label: "{{ item.item }}"
      when: item is not skipped

    # ================================
    # TASK 3: CHECK CERTIFICATE EXPIRY
    # ================================
    - name: Find certificate files on reachable hosts
      find:
        paths: "{{ cert_paths }}"
        patterns: "*.crt,*.pem"
        file_type: file
        recurse: yes
        follow: yes
      register: cert_files_check
      loop: "{{ monitoring_report.reachability.reachable_hosts }}"
      loop_control:
        label: "{{ item }}"
      delegate_to: "{{ item }}"
      ignore_errors: yes
      changed_when: false

    - name: Check certificate expiry dates
      shell: |
        {% set certs = item.files | default([]) %}
        {% if certs | length > 0 %}
        {% for cert in certs %}
        echo "FILE:{{ cert.path }}"
        openssl x509 -in "{{ cert.path }}" -noout -enddate 2>/dev/null || echo "ERROR"
        {% endfor %}
        {% else %}
        # If no files found via find module, try common cert filenames in live folders
        for domain_dir in /etc/letsencrypt/live/*/; do
          if [ -f "$domain_dir/cert.pem" ]; then
            echo "FILE:$domain_dir/cert.pem"
            openssl x509 -in "$domain_dir/cert.pem" -noout -enddate 2>/dev/null || echo "ERROR"
          fi
        done
        {% endif %}
      register: cert_expiry_check
      loop: "{{ cert_files_check.results }}"
      loop_control:
        label: "{{ item.item }}"
      delegate_to: "{{ item.item }}"
      ignore_errors: yes
      changed_when: false

    - name: Initialize certificate data dict
      set_fact:
        cert_expiry_data: {}

    - name: Parse certificate expiry results
      set_fact:
        cert_details: "{{ cert_details | default({}) }}"

    - name: Build certificate details for each host
      set_fact:
        cert_details: "{{ cert_details | combine({item.item | string: {'output': item.stdout_lines | default([]), 'raw': item.stdout | default('')}}) }}"
      loop: "{{ cert_expiry_check.results }}"
      loop_control:
        label: "{{ item.item }}"

    - name: Build certificate report from expiry data
      set_fact:
        monitoring_report: >-
          {{
            monitoring_report | combine({
              'certificates': {
                'checked_hosts': monitoring_report.reachability.reachable_hosts,
                'expiring_soon': [],
                'expired': [],
                'hosts_detail': cert_expiry_data
              }
            }, recursive=True)
          }}
      when: cert_expiry_data is defined and cert_expiry_data | length > 0
    
    # ================================
    # ALERTING SECTION
    # ================================
    - name: Send alert email - Unreachable hosts detected
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        secure: "never"
        from: "{{ email_from }}"
        to: "{{ alert_recipients }}"
        subject: "ðŸš¨ ALERT: {{ monitoring_report['reachability']['unreachable_hosts'] | length }} host(s) unreachable - {{ monitoring_report['timestamp'] }}"
        body: |
          HOST REACHABILITY ALERT
          =======================
          
          Timestamp: {{ monitoring_report['timestamp'] }}
          
          STATUS: UNREACHABLE HOSTS DETECTED
          
          {{ monitoring_report['reachability']['unreachable_hosts'] | length }} out of {{ monitoring_report['reachability']['total_checked'] }} hosts are currently unreachable.
          
          UNREACHABLE HOSTS:
          {% for host in monitoring_report['reachability']['unreachable_hosts'] | sort %}
          â€¢ {{ host }} ({{ monitoring_report['reachability']['hosts_detail'][host]['ip'] }})
            State: {{ monitoring_report['reachability']['hosts_detail'][host]['state'] }}
            Owner: {{ monitoring_report['reachability']['hosts_detail'][host]['owner'] }}
          {% endfor %}
          
          Please investigate immediately.
          
          Regards,
          Automated Monitoring System
      when:
        - monitoring_report['reachability']['unreachable_hosts'] | length > 0
      ignore_errors: yes

    - name: Send alert email - High disk usage detected
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        secure: "never"
        from: "{{ email_from }}"
        to: "{{ alert_recipients }}"
        subject: "âš ï¸ ALERT: {{ monitoring_report['disk_space']['high_usage_hosts'] | length }} host(s) with high disk usage (>{{ disk_usage_threshold }}%) - {{ monitoring_report['timestamp'] }}"
        body: |
          DISK SPACE ALERT
          ================
          
          Timestamp: {{ monitoring_report['timestamp'] }}
          
          STATUS: HIGH DISK USAGE DETECTED
          
          {{ monitoring_report['disk_space']['high_usage_hosts'] | length }} host(s) have disk usage exceeding {{ disk_usage_threshold }}%.
          
          HOSTS WITH HIGH DISK USAGE:
          {% for host in monitoring_report['disk_space']['high_usage_hosts'] | sort %}
          â€¢ {{ host }}
            Filesystems with high usage:
            {% for fs, data in monitoring_report['disk_space']['hosts_detail'][host].items() %}
              {% if data.alert %}
              - {{ fs }}: {{ data.usage }}% (threshold: {{ disk_usage_threshold }}%)
              {% endif %}
            {% endfor %}
            IP: {{ monitoring_report['reachability']['hosts_detail'][host]['ip'] }}
            Owner: {{ monitoring_report['reachability']['hosts_detail'][host]['owner'] }}
          {% endfor %}
          
          Please clean up disk space on these hosts.
          
          Regards,
          Automated Monitoring System
      when:
        - monitoring_report['disk_space']['high_usage_hosts'] | length > 0
      ignore_errors: yes

    - name: Send alert email - Certificate expiry warning
      community.general.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port }}"
        secure: "never"
        from: "{{ email_from }}"
        to: "{{ alert_recipients }}"
        subject: "ðŸ“… ALERT: Certificates expiring soon or expired - {{ monitoring_report['timestamp'] }}"
        body: |
          CERTIFICATE EXPIRY ALERT
          ========================
          
          Timestamp: {{ monitoring_report['timestamp'] }}
          
          STATUS: CERTIFICATE EXPIRY DETECTED
          
          {% if monitoring_report['certificates']['expired'] | length > 0 %}
          EXPIRED CERTIFICATES:
          {% for host in monitoring_report['certificates']['expired'] | sort %}
          â€¢ {{ host }}
            Details: {{ monitoring_report['certificates']['hosts_detail'][host] | default('N/A') }}
          {% endfor %}
          
          {% endif %}
          {% if monitoring_report['certificates']['expiring_soon'] | length > 0 %}
          CERTIFICATES EXPIRING SOON (within {{ cert_expiry_warning_days }} days):
          {% for host in monitoring_report['certificates']['expiring_soon'] | sort %}
          â€¢ {{ host }}
            Details: {{ monitoring_report['certificates']['hosts_detail'][host] | default('N/A') }}
          {% endfor %}
          
          {% endif %}
          Please renew these certificates immediately.
          
          Regards,
          Automated Monitoring System
      when:
        - (monitoring_report['certificates']['expired'] | length > 0) or (monitoring_report['certificates']['expiring_soon'] | length > 0)
      ignore_errors: yes

    - name: Display comprehensive monitoring summary
      debug:
        msg: |
          ========================================
          COMPREHENSIVE MONITORING SUMMARY
          ========================================
          Timestamp: {{ monitoring_report.timestamp }}
          
          1. REACHABILITY CHECK
          --------------------
          Total Hosts: {{ monitoring_report.reachability.total_checked }}
          Reachable: {{ monitoring_report.reachability.reachable_hosts | length }}
          Unreachable: {{ monitoring_report.reachability.unreachable_hosts | length }}
          
          2. DISK SPACE CHECK
          -------------------
          Hosts Checked: {{ monitoring_report.disk_space.checked_hosts | length }}
          High Usage (>{{ disk_usage_threshold }}%): {{ monitoring_report.disk_space.high_usage_hosts | length }}
          
          3. CERTIFICATE CHECK
          --------------------
          Hosts Checked: {{ monitoring_report.certificates.checked_hosts | length }}
          Expired: {{ monitoring_report.certificates.expired | length }}
          Expiring Soon (<{{ cert_expiry_warning_days }} days): {{ monitoring_report.certificates.expiring_soon | length }}
          
          ========================================